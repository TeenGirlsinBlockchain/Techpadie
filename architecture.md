# Techpadie Backend — Architecture & Plan

## A) FOLDER STRUCTURE

```
techpadie/
├── prisma/
│   ├── schema.prisma                    # Full DB schema
│   ├── seed.ts                          # Seed script (super admin, sample courses)
│   └── migrations/                      # Auto-generated by prisma migrate
│
├── scripts/
│   ├── worker.ts                        # Background job worker (polls jobs table)
│   ├── run-worker.sh                    # Shell wrapper: npx tsx scripts/worker.ts
│   └── create-admin.ts                  # One-off: create super admin user
│
├── src/
│   ├── app/
│   │   └── api/                         # Next.js Route Handlers (the API)
│   │       ├── auth/
│   │       │   ├── signup/route.ts
│   │       │   ├── login/route.ts
│   │       │   ├── verify-otp/route.ts
│   │       │   ├── logout/route.ts
│   │       │   ├── me/route.ts
│   │       │   └── reset-password/
│   │       │       ├── request/route.ts
│   │       │       └── confirm/route.ts
│   │       │
│   │       ├── admin/
│   │       │   ├── creators/
│   │       │   │   ├── route.ts          # GET list pending creators
│   │       │   │   └── [creatorId]/
│   │       │   │       └── review/route.ts  # POST approve/reject
│   │       │   ├── courses/
│   │       │   │   ├── route.ts          # GET list pending courses
│   │       │   │   └── [courseId]/
│   │       │   │       └── review/route.ts  # POST approve/reject
│   │       │   └── analytics/route.ts    # GET platform analytics
│   │       │
│   │       ├── creator/
│   │       │   ├── profile/route.ts      # GET/PUT creator profile
│   │       │   ├── courses/
│   │       │   │   ├── route.ts          # GET list / POST create course
│   │       │   │   └── [courseId]/
│   │       │   │       ├── route.ts      # GET / PUT course details
│   │       │   │       ├── submit/route.ts   # POST submit for review
│   │       │   │       ├── modules/
│   │       │   │       │   ├── route.ts  # GET / POST modules
│   │       │   │       │   └── [moduleId]/
│   │       │   │       │       ├── route.ts       # PUT / DELETE module
│   │       │   │       │       └── lessons/
│   │       │   │       │           ├── route.ts   # GET / POST lessons
│   │       │   │       │           └── [lessonId]/
│   │       │   │       │               └── route.ts # PUT / DELETE lesson
│   │       │   │       └── analytics/route.ts  # GET course analytics
│   │       │   └── analytics/route.ts    # GET creator dashboard analytics
│   │       │
│   │       ├── courses/
│   │       │   ├── route.ts              # GET browse published courses
│   │       │   └── [courseId]/
│   │       │       ├── route.ts          # GET course detail
│   │       │       ├── enroll/route.ts   # POST enroll
│   │       │       └── lessons/
│   │       │           └── [lessonId]/
│   │       │               ├── route.ts        # GET lesson content
│   │       │               ├── progress/route.ts   # PUT update progress
│   │       │               ├── generated/route.ts  # GET quiz/flashcards/summary
│   │       │               └── audio/route.ts      # GET audio asset URL
│   │       │
│   │       ├── quiz/
│   │       │   └── [lessonId]/
│   │       │       └── attempt/route.ts  # POST submit quiz attempt
│   │       │
│   │       ├── rewards/
│   │       │   └── [enrollmentId]/
│   │       │       └── claim/route.ts    # POST claim reward + certificate
│   │       │
│   │       └── certificates/
│   │           └── [certificateId]/
│   │               └── verify/route.ts   # GET public verification
│   │
│   ├── lib/                              # Low-level utilities (no business logic)
│   │   ├── db.ts                         # Prisma client singleton
│   │   ├── crypto.ts                     # Password hash, OTP generation, token gen
│   │   ├── session. ts                    # Session create/validate/destroy
│   │   ├── email.ts                      # Resend wrapper
│   │   ├── rate-limit.ts                 # IP + user rate limiter (in-memory + DB fallback)
│   │   ├── ai.ts                         # Google Gemini AI client wrapper
│   │   ├── tts.ts                        # Google Gemini TTS/audio generation wrapper
│   │   ├── chain.ts                      # Flare blockchain client (ethers.js)
│   │   ├── certificate-pdf.ts            # PDF/image certificate generator
│   │   ├── storage.ts                    # File storage abstraction (local/S3)
│   │   ├── errors.ts                     # Custom error classes (AppError, etc.)
│   │   ├── logger.ts                     # Structured logger
│   │   └── env.ts                        # Validated env vars (zod)
│   │
│   ├── server/                           # Business logic layer
│   │   ├── services/                     # Orchestration (calls repos, triggers jobs)
│   │   │   ├── auth.service.ts
│   │   │   ├── user.service.ts
│   │   │   ├── course.service.ts
│   │   │   ├── enrollment.service.ts
│   │   │   ├── progress.service.ts
│   │   │   ├── generation.service.ts     # AI content generation orchestrator
│   │   │   ├── audio.service.ts          # Audio generation orchestrator
│   │   │   ├── quiz.service.ts
│   │   │   ├── reward.service.ts         # Token + certificate orchestrator
│   │   │   ├── admin.service.ts
│   │   │   ├── analytics.service.ts
│   │   │   └── job.service.ts            # Job queue operations
│   │   │
│   │   ├── repositories/                 # Pure data access (Prisma queries)
│   │   │   ├── user.repo.ts
│   │   │   ├── session.repo.ts
│   │   │   ├── course.repo.ts
│   │   │   ├── enrollment.repo.ts
│   │   │   ├── progress.repo.ts
│   │   │   ├── generation.repo.ts
│   │   │   ├── audio.repo.ts
│   │   │   ├── quiz.repo.ts
│   │   │   ├── reward.repo.ts
│   │   │   ├── job.repo.ts
│   │   │   └── audit.repo.ts
│   │   │
│   │   ├── validators/                   # Zod schemas for request validation
│   │   │   ├── auth.validator.ts
│   │   │   ├── course.validator.ts
│   │   │   ├── lesson.validator.ts
│   │   │   ├── progress.validator.ts
│   │   │   ├── quiz.validator.ts
│   │   │   ├── reward.validator.ts
│   │   │   └── admin.validator.ts
│   │   │
│   │   ├── policies/                     # Authorization checks
│   │   │   ├── auth.policy.ts            # requireAuth, requireRole
│   │   │   ├── course.policy.ts          # canEditCourse, canPublishCourse
│   │   │   └── admin.policy.ts           # isSuperAdmin checks
│   │   │
│   │   └── workers/                      # Job handler functions
│   │       ├── ai-generation.worker.ts   # Quiz/flashcards/summary generation
│   │       ├── audio-generation.worker.ts # TTS audio generation
│   │       ├── reward-distribution.worker.ts # Flare token transfer
│   │       └── certificate-generation.worker.ts # PDF cert + optional on-chain hash
│   │
│   └── middleware/
│       └── with-auth.ts                  # Middleware helper for route handlers
src/middleware/with-auth.ts

In Next.js, global middleware normally lives at:

src/middleware.ts

Not inside a folder.

So:

with-auth.ts = helper function (fine)

but real middleware file must be:

src/middleware.ts

Otherwise it won’t run automatically.
│
├── .env.example
├── package.json
├── tsconfig.json
└── next.config.js
```

## C) ENVIRONMENT VARIABLES

```env
# ─── Database ───
DATABASE_URL="postgresql://user:password@localhost:5432/techpadie?schema=public"

# ─── App ───
APP_URL="http://localhost:3000"
APP_NAME="Techpadie"
NODE_ENV="development"

# ─── Auth ───
SESSION_SECRET="your-64-char-random-hex-string"
OTP_EXPIRY_MINUTES=10
OTP_MAX_ATTEMPTS=5
SESSION_MAX_AGE_HOURS=168

# ─── Email (Resend) ───
RESEND_API_KEY="re_xxxxxxxxxxxx"
EMAIL_FROM="Techpadie <noreply@techpadie.com>"

# ─── AI (Google Gemini) ───
GOOGLE_GEMINI_API_KEY="your-gemini-api-key"
AI_MODEL="gemini-2.0-flash"
AI_MAX_FLASHCARDS=10
AI_MAX_QUIZ_QUESTIONS=5

# ─── TTS (Google Gemini Audio) ───
TTS_MODEL="gemini-2.0-flash"

# ─── Blockchain (Flare) ───
FLARE_RPC_URL="https://flare-api.flare.network/ext/C/rpc"
FLARE_CHAIN_ID=14
FLARE_TOKEN_CONTRACT_ADDRESS="0x..."
FLARE_SIGNER_PRIVATE_KEY="encrypted:your-encrypted-private-key"
FLARE_SIGNER_ENCRYPTION_KEY="your-32-byte-hex-encryption-key"

# ─── Storage ───
STORAGE_PROVIDER="local"
STORAGE_LOCAL_PATH="./uploads"
# S3_BUCKET="techpadie-assets"
# S3_REGION="eu-west-1"
# S3_ACCESS_KEY="..."
# S3_SECRET_KEY="..."

# ─── Rate Limiting ───
RATE_LIMIT_AUTH_WINDOW_MS=900000
RATE_LIMIT_AUTH_MAX=10
RATE_LIMIT_API_WINDOW_MS=60000
RATE_LIMIT_API_MAX=100

# ─── Worker ───
WORKER_POLL_INTERVAL_MS=5000
WORKER_MAX_RETRIES=3
WORKER_CONCURRENCY=2
```

## E) IMPLEMENTATION PLAN (Ordered)

### Phase 1: Foundation (Week 1)
1. **Prisma schema** — all tables, enums, relations, indexes
2. **lib/** utilities — db, crypto, session, email, env, errors, logger, rate-limit
3. **Auth endpoints** — signup, login, verify-otp, logout, me, password reset
4. **Middleware** — withAuth, requireRole

**Risks:**
- OTP timing attacks → Mitigate with constant-time comparison
- User enumeration → Same response shape for existing/non-existing emails
- Session fixation → Generate new session ID on every OTP verification

### Phase 2: Course Management (Week 2)
5. **Creator onboarding** — profile creation, KYC fields
6. **Course CRUD** — courses, modules, lessons, translations
7. **Admin review flow** — approve/reject creators and courses
8. **Validators** — Zod schemas for all inputs

**Risks:**
- Course content injection (XSS in lesson HTML) → Sanitize on input with DOMPurify
- Race conditions on publish status → Use DB-level status transitions with WHERE clause

### Phase 3: Job Queue + AI/Audio (Week 3)
9. **Job queue** — jobs table, job.service, worker runner
10. **AI generation worker** — quiz, flashcards, summary per (lesson, language, version)
11. **Audio generation worker** — TTS per (lesson, language)
12. **Content versioning** — contentHash on lessons, regenerate only on change

**Risks:**
- Worker crashes mid-job → Heartbeat + timeout, job returns to "queued" after stale threshold
- AI hallucination → Prompt engineering: "ONLY use the provided text", structured JSON output
- Cost explosion → Rate limit generation jobs, max retries, configurable per-course limits

### Phase 4: Learning Flow (Week 4)
13. **Course browsing** — public catalog with filters
14. **Enrollment** — enroll endpoint, idempotent
15. **Lesson progress** — read, audio position tracking, completion
16. **Quiz** — fetch generated quiz, submit attempt, score calculation

**Risks:**
- Quiz answer cheating → Don't send correct answers to client until after submission
- Progress desync → Use server timestamps, last-write-wins with optimistic locking

### Phase 5: Rewards + Certificates (Week 5)
17. **Certificate generation** — Techpadie generates PDF certificate
18. **On-chain hash** — Store certificate hash on Flare for verification (Option A)
19. **Token distribution** — Transfer tokens via Flare smart contract
20. **Idempotency** — Unique constraint on (enrollmentId) for certificates + rewards

**Risks:**
- Double token distribution → Idempotency key + DB unique constraint + check-before-send
- Blockchain transaction failure → Job retries with exponential backoff, status tracking
- Private key compromise → Encrypted at rest, never logged, rotatable

### Phase 6: Analytics + Hardening (Week 6)
21. **Analytics endpoints** — student, creator, admin dashboards
22. **Audit logging** — all admin + auth actions logged
23. **Rate limiting** — per-endpoint configuration
24. **Testing** — integration tests for auth flow, quiz submission, reward claim

**Risks:**
- Analytics query performance → Pre-aggregated tables or materialized views
- Bot abuse → Rate limiting + CAPTCHA (future) + anomaly detection flags

---

## ARCHITECTURE DECISIONS

### Job Queue: Database-backed (jobs table)
**Why not Redis/BullMQ?** Keeps the stack simple — single PostgreSQL dependency. The jobs table with `status`, `runAt`, `attempts`, `lockedUntil` fields provides exactly the semantics we need. Worker polls every 5 seconds, claims jobs with `UPDATE ... WHERE status = 'queued' AND lockedUntil < NOW()`, processes them, marks complete/failed.

**Scaling path:** When traffic justifies it, swap to BullMQ + Redis without changing the service layer — only job.repo changes.

### Certificate: Techpadie generates, Flare verifies
Techpadie generates a PDF certificate with a unique certificateId. The certificate hash (SHA-256 of the PDF bytes) is stored on Flare via a simple smart contract (`storeCertificateHash(bytes32 certHash, bytes32 certId)`). Anyone can verify by hashing the PDF and comparing against the on-chain record. No NFT minting needed — simpler, cheaper, just as verifiable.

### Auth: Custom with OTP
No external auth providers. Email + password + OTP verification. Sessions stored in DB, cookie is HttpOnly + Secure + SameSite=Lax. This gives full control over the auth flow and avoids vendor lock-in.

### AI Content: Versioned and Cached
Generated content (quiz, flashcards, summary) is stored with `contentHash` — a SHA-256 of the lesson text. Regeneration only happens when the hash changes or an admin/creator explicitly triggers it. This prevents unnecessary API calls and ensures consistency.